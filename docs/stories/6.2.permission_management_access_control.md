# Story 6.2: 权限管理与访问控制

## Status
Draft

## Story
**As a** 系统管理员和企业用户,
**I want** 一个灵活强大的权限管理与访问控制系统，支持细粒度的权限配置和动态权限管理,
**so that** 我可以精确控制用户对系统资源的访问，确保数据安全和合规性要求

## Acceptance Criteria
1. 实现层次化的权限管理体系，支持组织架构和部门权限继承
2. 建立资源级访问控制，支持文档、知识图谱、API等资源的细粒度权限
3. 实现动态权限评估引擎，支持基于上下文的访问控制决策
4. 支持权限委派和临时授权机制
5. 建立权限审批工作流，支持权限申请和审批流程
6. 实现数据脱敏和字段级访问控制
7. 提供权限可视化管理界面和权限分析报告
8. 建立权限变更审计和合规性检查

## Tasks / Subtasks
- [ ] 实现层次化权限管理 (AC: 1)
  - [ ] 设计组织架构权限模型
  - [ ] 实现部门和团队权限继承
  - [ ] 开发权限层级管理功能
  - [ ] 建立权限冲突解决机制
- [ ] 建立资源级访问控制 (AC: 2)
  - [ ] 设计资源权限标识系统
  - [ ] 实现文档级权限控制
  - [ ] 开发知识图谱访问控制
  - [ ] 建立API接口权限管理
- [ ] 实现动态权限评估 (AC: 3)
  - [ ] 设计权限评估引擎架构
  - [ ] 实现基于属性的访问控制(ABAC)
  - [ ] 开发上下文感知的权限决策
  - [ ] 建立权限缓存和性能优化
- [ ] 实现权限委派机制 (AC: 4)
  - [ ] 设计权限委派模型
  - [ ] 实现临时权限授权
  - [ ] 开发权限代理功能
  - [ ] 建立委派权限的生命周期管理
- [ ] 建立权限审批工作流 (AC: 5)
  - [ ] 设计权限申请流程
  - [ ] 实现多级审批机制
  - [ ] 开发权限变更通知系统
  - [ ] 建立权限回收和到期管理
- [ ] 实现数据脱敏控制 (AC: 6)
  - [ ] 设计数据分类和敏感度标识
  - [ ] 实现字段级访问控制
  - [ ] 开发动态数据脱敏功能
  - [ ] 建立数据访问日志记录
- [ ] 开发权限管理界面 (AC: 7)
  - [ ] 实现权限可视化展示
  - [ ] 开发权限配置管理界面
  - [ ] 建立权限分析和报告功能
  - [ ] 实现权限搜索和过滤
- [ ] 建立权限审计系统 (AC: 8)
  - [ ] 实现权限变更审计日志
  - [ ] 开发合规性检查功能
  - [ ] 建立权限异常检测
  - [ ] 实现权限合规报告生成

## Dev Notes

### 架构上下文
权限管理与访问控制是Knowledge_RAG系统安全架构的核心组件，需要在保证安全性的同时提供良好的用户体验和管理效率。系统需要支持复杂的企业组织架构和多样化的权限需求，同时满足合规性要求。

### 核心技术要求
- **权限引擎**: Apache Shiro 或自研权限引擎
- **规则引擎**: Drools 用于复杂权限规则评估
- **工作流引擎**: Activiti 或 Camunda 用于审批流程
- **缓存系统**: Redis 用于权限缓存和性能优化
- **消息队列**: RabbitMQ 用于权限变更通知
- **数据库**: PostgreSQL 存储权限数据和审计日志
- **搜索引擎**: Elasticsearch 用于权限搜索和分析

### 权限管理核心架构

#### 权限管理服务
```java
// PermissionManagementService.java
@Service
@Transactional
public class PermissionManagementService {
    
    private final PermissionRepository permissionRepository;
    private final ResourceRepository resourceRepository;
    private final OrganizationRepository organizationRepository;
    private final PermissionEvaluationEngine evaluationEngine;
    private final PermissionCacheService cacheService;
    private final AuditService auditService;
    
    /**
     * 创建权限
     */
    public Permission createPermission(CreatePermissionRequest request) {
        // 验证权限名称唯一性
        if (permissionRepository.existsByName(request.getName())) {
            throw new DuplicatePermissionException("Permission already exists: " + request.getName());
        }
        
        Permission permission = Permission.builder()
            .name(request.getName())
            .description(request.getDescription())
            .resourceType(request.getResourceType())
            .actionType(request.getActionType())
            .scope(request.getScope())
            .conditions(request.getConditions())
            .createdBy(getCurrentUser().getId())
            .createdAt(Instant.now())
            .build();
        
        permission = permissionRepository.save(permission);
        
        // 清除相关缓存
        cacheService.evictPermissionCache();
        
        // 记录审计日志
        auditService.logPermissionCreated(permission, getCurrentUser());
        
        return permission;
    }
    
    /**
     * 分配权限给用户
     */
    public void assignPermissionToUser(Long userId, Long permissionId, PermissionAssignmentRequest request) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new UserNotFoundException("User not found: " + userId));
        
        Permission permission = permissionRepository.findById(permissionId)
            .orElseThrow(() -> new PermissionNotFoundException("Permission not found: " + permissionId));
        
        // 检查是否已经分配
        if (userPermissionRepository.existsByUserIdAndPermissionId(userId, permissionId)) {
            throw new DuplicateAssignmentException("Permission already assigned to user");
        }
        
        UserPermission userPermission = UserPermission.builder()
            .userId(userId)
            .permissionId(permissionId)
            .grantedBy(getCurrentUser().getId())
            .grantedAt(Instant.now())
            .expiresAt(request.getExpiresAt())
            .conditions(request.getConditions())
            .build();
        
        userPermissionRepository.save(userPermission);
        
        // 清除用户权限缓存
        cacheService.evictUserPermissionCache(userId);
        
        // 发送通知
        notificationService.sendPermissionGrantedNotification(user, permission);
        
        // 记录审计日志
        auditService.logPermissionAssigned(user, permission, getCurrentUser());
    }
    
    /**
     * 分配权限给角色
     */
    public void assignPermissionToRole(Long roleId, Long permissionId, PermissionAssignmentRequest request) {
        Role role = roleRepository.findById(roleId)
            .orElseThrow(() -> new RoleNotFoundException("Role not found: " + roleId));
        
        Permission permission = permissionRepository.findById(permissionId)
            .orElseThrow(() -> new PermissionNotFoundException("Permission not found: " + permissionId));
        
        RolePermission rolePermission = RolePermission.builder()
            .roleId(roleId)
            .permissionId(permissionId)
            .grantedBy(getCurrentUser().getId())
            .grantedAt(Instant.now())
            .conditions(request.getConditions())
            .build();
        
        rolePermissionRepository.save(rolePermission);
        
        // 清除角色权限缓存
        cacheService.evictRolePermissionCache(roleId);
        
        // 清除所有拥有该角色的用户权限缓存
        List<User> usersWithRole = userRepository.findByRoleId(roleId);
        usersWithRole.forEach(user -> cacheService.evictUserPermissionCache(user.getId()));
        
        auditService.logPermissionAssignedToRole(role, permission, getCurrentUser());
    }
    
    /**
     * 撤销用户权限
     */
    public void revokePermissionFromUser(Long userId, Long permissionId, String reason) {
        UserPermission userPermission = userPermissionRepository
            .findByUserIdAndPermissionId(userId, permissionId)
            .orElseThrow(() -> new PermissionAssignmentNotFoundException(
                "Permission assignment not found"));
        
        userPermission.setRevokedBy(getCurrentUser().getId());
        userPermission.setRevokedAt(Instant.now());
        userPermission.setRevokeReason(reason);
        userPermission.setActive(false);
        
        userPermissionRepository.save(userPermission);
        
        // 清除缓存
        cacheService.evictUserPermissionCache(userId);
        
        // 发送通知
        User user = userRepository.findById(userId).orElse(null);
        Permission permission = permissionRepository.findById(permissionId).orElse(null);
        if (user != null && permission != null) {
            notificationService.sendPermissionRevokedNotification(user, permission, reason);
            auditService.logPermissionRevoked(user, permission, getCurrentUser(), reason);
        }
    }
    
    /**
     * 获取用户有效权限
     */
    public Set<Permission> getUserEffectivePermissions(Long userId) {
        // 先检查缓存
        Set<Permission> cachedPermissions = cacheService.getUserPermissions(userId);
        if (cachedPermissions != null) {
            return cachedPermissions;
        }
        
        Set<Permission> permissions = new HashSet<>();
        
        // 获取直接分配的权限
        List<UserPermission> directPermissions = userPermissionRepository
            .findActiveByUserId(userId);
        permissions.addAll(directPermissions.stream()
            .map(up -> permissionRepository.findById(up.getPermissionId()))
            .filter(Optional::isPresent)
            .map(Optional::get)
            .collect(Collectors.toSet()));
        
        // 获取通过角色继承的权限
        User user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            for (Role role : user.getRoles()) {
                permissions.addAll(getRoleEffectivePermissions(role.getId()));
            }
            
            // 获取通过组织架构继承的权限
            if (user.getOrganizationId() != null) {
                permissions.addAll(getOrganizationPermissions(user.getOrganizationId()));
            }
        }
        
        // 缓存结果
        cacheService.cacheUserPermissions(userId, permissions);
        
        return permissions;
    }
    
    /**
     * 检查用户是否有特定资源的权限
     */
    public boolean hasResourcePermission(Long userId, String resourceType, String resourceId, String action) {
        // 构建权限检查上下文
        PermissionContext context = PermissionContext.builder()
            .userId(userId)
            .resourceType(resourceType)
            .resourceId(resourceId)
            .action(action)
            .timestamp(Instant.now())
            .build();
        
        // 使用权限评估引擎进行检查
        PermissionEvaluationResult result = evaluationEngine.evaluate(context);
        
        // 记录权限检查日志
        auditService.logPermissionCheck(context, result);
        
        return result.isGranted();
    }
    
    private Set<Permission> getRoleEffectivePermissions(Long roleId) {
        Set<Permission> permissions = new HashSet<>();
        
        // 获取角色直接权限
        List<RolePermission> rolePermissions = rolePermissionRepository.findActiveByRoleId(roleId);
        permissions.addAll(rolePermissions.stream()
            .map(rp -> permissionRepository.findById(rp.getPermissionId()))
            .filter(Optional::isPresent)
            .map(Optional::get)
            .collect(Collectors.toSet()));
        
        // 获取父角色权限（角色继承）
        Role role = roleRepository.findById(roleId).orElse(null);
        if (role != null && role.getParentRoleId() != null) {
            permissions.addAll(getRoleEffectivePermissions(role.getParentRoleId()));
        }
        
        return permissions;
    }
    
    private Set<Permission> getOrganizationPermissions(Long organizationId) {
        Set<Permission> permissions = new HashSet<>();
        
        // 获取组织直接权限
        List<OrganizationPermission> orgPermissions = organizationPermissionRepository
            .findActiveByOrganizationId(organizationId);
        permissions.addAll(orgPermissions.stream()
            .map(op -> permissionRepository.findById(op.getPermissionId()))
            .filter(Optional::isPresent)
            .map(Optional::get)
            .collect(Collectors.toSet()));
        
        // 获取父组织权限（组织继承）
        Organization org = organizationRepository.findById(organizationId).orElse(null);
        if (org != null && org.getParentOrganizationId() != null) {
            permissions.addAll(getOrganizationPermissions(org.getParentOrganizationId()));
        }
        
        return permissions;
    }
}
```

#### 权限评估引擎
```java
// PermissionEvaluationEngine.java
@Component
public class PermissionEvaluationEngine {
    
    private final KieContainer kieContainer;
    private final PermissionRuleRepository ruleRepository;
    private final ResourceAccessService resourceAccessService;
    private final RedisTemplate<String, Object> redisTemplate;
    
    /**
     * 评估权限请求
     */
    public PermissionEvaluationResult evaluate(PermissionContext context) {
        // 创建Drools会话
        KieSession kieSession = kieContainer.newKieSession();
        
        try {
            // 设置全局变量
            kieSession.setGlobal("resourceAccessService", resourceAccessService);
            kieSession.setGlobal("currentTime", Instant.now());
            
            // 插入事实
            kieSession.insert(context);
            kieSession.insert(getUserInfo(context.getUserId()));
            kieSession.insert(getResourceInfo(context.getResourceType(), context.getResourceId()));
            
            // 插入用户权限
            Set<Permission> userPermissions = getUserEffectivePermissions(context.getUserId());
            userPermissions.forEach(kieSession::insert);
            
            // 执行规则
            int rulesExecuted = kieSession.fireAllRules();
            
            // 获取评估结果
            Collection<PermissionEvaluationResult> results = kieSession.getObjects(
                new ClassObjectFilter(PermissionEvaluationResult.class));
            
            PermissionEvaluationResult result = results.stream()
                .findFirst()
                .orElse(PermissionEvaluationResult.denied("No matching rules found"));
            
            // 缓存结果（短期缓存）
            cacheEvaluationResult(context, result);
            
            return result;
            
        } finally {
            kieSession.dispose();
        }
    }
    
    /**
     * 批量评估权限
     */
    public Map<String, PermissionEvaluationResult> evaluateBatch(List<PermissionContext> contexts) {
        Map<String, PermissionEvaluationResult> results = new HashMap<>();
        
        // 检查缓存
        Map<String, PermissionEvaluationResult> cachedResults = getCachedResults(contexts);
        results.putAll(cachedResults);
        
        // 过滤出需要评估的上下文
        List<PermissionContext> uncachedContexts = contexts.stream()
            .filter(ctx -> !cachedResults.containsKey(ctx.getContextKey()))
            .collect(Collectors.toList());
        
        if (!uncachedContexts.isEmpty()) {
            KieSession kieSession = kieContainer.newKieSession();
            
            try {
                // 设置全局变量
                kieSession.setGlobal("resourceAccessService", resourceAccessService);
                kieSession.setGlobal("currentTime", Instant.now());
                
                // 批量插入事实
                Set<Long> userIds = uncachedContexts.stream()
                    .map(PermissionContext::getUserId)
                    .collect(Collectors.toSet());
                
                Map<Long, UserInfo> userInfoMap = getUserInfoBatch(userIds);
                Map<String, ResourceInfo> resourceInfoMap = getResourceInfoBatch(uncachedContexts);
                Map<Long, Set<Permission>> userPermissionsMap = getUserPermissionsBatch(userIds);
                
                // 插入所有事实
                uncachedContexts.forEach(kieSession::insert);
                userInfoMap.values().forEach(kieSession::insert);
                resourceInfoMap.values().forEach(kieSession::insert);
                userPermissionsMap.values().stream()
                    .flatMap(Set::stream)
                    .forEach(kieSession::insert);
                
                // 执行规则
                kieSession.fireAllRules();
                
                // 收集结果
                Collection<PermissionEvaluationResult> evaluationResults = kieSession.getObjects(
                    new ClassObjectFilter(PermissionEvaluationResult.class));
                
                for (PermissionEvaluationResult result : evaluationResults) {
                    results.put(result.getContextKey(), result);
                    cacheEvaluationResult(result.getContext(), result);
                }
                
                // 为没有结果的上下文添加默认拒绝结果
                for (PermissionContext context : uncachedContexts) {
                    if (!results.containsKey(context.getContextKey())) {
                        PermissionEvaluationResult deniedResult = 
                            PermissionEvaluationResult.denied("No matching rules found");
                        results.put(context.getContextKey(), deniedResult);
                        cacheEvaluationResult(context, deniedResult);
                    }
                }
                
            } finally {
                kieSession.dispose();
            }
        }
        
        return results;
    }
    
    /**
     * 动态添加权限规则
     */
    public void addPermissionRule(PermissionRule rule) {
        // 验证规则语法
        validateRuleContent(rule.getContent());
        
        // 保存规则到数据库
        ruleRepository.save(rule);
        
        // 重新加载规则引擎
        reloadRules();
        
        auditService.logRuleAdded(rule, getCurrentUser());
    }
    
    /**
     * 更新权限规则
     */
    public void updatePermissionRule(Long ruleId, String newContent) {
        PermissionRule rule = ruleRepository.findById(ruleId)
            .orElseThrow(() -> new RuleNotFoundException("Rule not found: " + ruleId));
        
        String oldContent = rule.getContent();
        
        // 验证新规则语法
        validateRuleContent(newContent);
        
        rule.setContent(newContent);
        rule.setUpdatedAt(Instant.now());
        rule.setUpdatedBy(getCurrentUser().getId());
        
        ruleRepository.save(rule);
        
        // 重新加载规则引擎
        reloadRules();
        
        auditService.logRuleUpdated(rule, oldContent, getCurrentUser());
    }
    
    private void validateRuleContent(String content) {
        try {
            // 创建临时KieSession来验证规则
            KieServices kieServices = KieServices.Factory.get();
            KieFileSystem kieFileSystem = kieServices.newKieFileSystem();
            
            kieFileSystem.write("src/main/resources/temp-rule.drl", content);
            
            KieBuilder kieBuilder = kieServices.newKieBuilder(kieFileSystem);
            kieBuilder.buildAll();
            
            if (kieBuilder.getResults().hasMessages(Message.Level.ERROR)) {
                throw new InvalidRuleException("Rule validation failed: " + 
                    kieBuilder.getResults().getMessages());
            }
        } catch (Exception e) {
            throw new InvalidRuleException("Rule validation failed", e);
        }
    }
    
    private void reloadRules() {
        // 重新构建KieContainer
        // 这里需要实现规则的动态重载逻辑
    }
}
```

### 资源级访问控制

#### 资源权限管理
```java
// ResourcePermissionService.java
@Service
public class ResourcePermissionService {
    
    private final ResourceRepository resourceRepository;
    private final ResourcePermissionRepository resourcePermissionRepository;
    private final DataMaskingService dataMaskingService;
    
    /**
     * 设置资源权限
     */
    public void setResourcePermission(SetResourcePermissionRequest request) {
        // 验证资源存在
        Resource resource = resourceRepository.findById(request.getResourceId())
            .orElseThrow(() -> new ResourceNotFoundException("Resource not found"));
        
        // 检查设置权限的权限
        if (!hasManagePermission(getCurrentUser(), resource)) {
            throw new AccessDeniedException("No permission to manage resource permissions");
        }
        
        ResourcePermission resourcePermission = ResourcePermission.builder()
            .resourceId(request.getResourceId())
            .resourceType(resource.getType())
            .subjectType(request.getSubjectType()) // USER, ROLE, ORGANIZATION
            .subjectId(request.getSubjectId())
            .permissionType(request.getPermissionType()) // READ, WRITE, DELETE, MANAGE
            .conditions(request.getConditions())
            .grantedBy(getCurrentUser().getId())
            .grantedAt(Instant.now())
            .expiresAt(request.getExpiresAt())
            .build();
        
        resourcePermissionRepository.save(resourcePermission);
        
        // 清除相关缓存
        clearResourcePermissionCache(request.getResourceId());
        
        auditService.logResourcePermissionSet(resourcePermission, getCurrentUser());
    }
    
    /**
     * 检查用户对资源的访问权限
     */
    public ResourceAccessResult checkResourceAccess(Long userId, String resourceId, String action) {
        // 构建访问上下文
        ResourceAccessContext context = ResourceAccessContext.builder()
            .userId(userId)
            .resourceId(resourceId)
            .action(action)
            .timestamp(Instant.now())
            .build();
        
        // 获取资源信息
        Resource resource = resourceRepository.findById(resourceId)
            .orElse(null);
        
        if (resource == null) {
            return ResourceAccessResult.denied("Resource not found");
        }
        
        // 检查资源状态
        if (!resource.isActive()) {
            return ResourceAccessResult.denied("Resource is not active");
        }
        
        // 检查用户权限
        List<ResourcePermission> permissions = getEffectiveResourcePermissions(userId, resourceId);
        
        for (ResourcePermission permission : permissions) {
            if (matchesPermission(permission, action)) {
                // 检查条件
                if (evaluateConditions(permission.getConditions(), context)) {
                    // 检查是否需要数据脱敏
                    DataMaskingPolicy maskingPolicy = getMaskingPolicy(userId, resource);
                    
                    return ResourceAccessResult.granted(permission, maskingPolicy);
                }
            }
        }
        
        return ResourceAccessResult.denied("No matching permissions found");
    }
    
    /**
     * 获取用户对资源的有效权限
     */
    private List<ResourcePermission> getEffectiveResourcePermissions(Long userId, String resourceId) {
        List<ResourcePermission> permissions = new ArrayList<>();
        
        // 直接用户权限
        permissions.addAll(resourcePermissionRepository.findByResourceIdAndSubjectTypeAndSubjectId(
            resourceId, SubjectType.USER, userId.toString()));
        
        // 通过角色获得的权限
        User user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            for (Role role : user.getRoles()) {
                permissions.addAll(resourcePermissionRepository.findByResourceIdAndSubjectTypeAndSubjectId(
                    resourceId, SubjectType.ROLE, role.getId().toString()));
            }
            
            // 通过组织获得的权限
            if (user.getOrganizationId() != null) {
                permissions.addAll(resourcePermissionRepository.findByResourceIdAndSubjectTypeAndSubjectId(
                    resourceId, SubjectType.ORGANIZATION, user.getOrganizationId().toString()));
            }
        }
        
        // 过滤过期权限
        Instant now = Instant.now();
        return permissions.stream()
            .filter(p -> p.getExpiresAt() == null || p.getExpiresAt().isAfter(now))
            .collect(Collectors.toList());
    }
    
    /**
     * 获取数据脱敏策略
     */
    private DataMaskingPolicy getMaskingPolicy(Long userId, Resource resource) {
        // 根据用户权限级别和资源敏感度确定脱敏策略
        User user = userRepository.findById(userId).orElse(null);
        if (user == null) {
            return DataMaskingPolicy.FULL_MASK;
        }
        
        // 检查用户是否有查看敏感数据的权限
        if (hasPermission(user, "data:view_sensitive")) {
            return DataMaskingPolicy.NO_MASK;
        }
        
        // 根据资源敏感度级别确定脱敏策略
        switch (resource.getSensitivityLevel()) {
            case HIGH:
                return DataMaskingPolicy.FULL_MASK;
            case MEDIUM:
                return DataMaskingPolicy.PARTIAL_MASK;
            case LOW:
            default:
                return DataMaskingPolicy.NO_MASK;
        }
    }
}
```

### 数据脱敏服务

#### 数据脱敏实现
```java
// DataMaskingService.java
@Service
public class DataMaskingService {
    
    private final MaskingRuleRepository maskingRuleRepository;
    private final RedisTemplate<String, Object> redisTemplate;
    
    /**
     * 对数据进行脱敏处理
     */
    public <T> T maskData(T data, DataMaskingPolicy policy, Class<T> clazz) {
        if (policy == DataMaskingPolicy.NO_MASK) {
            return data;
        }
        
        try {
            // 创建数据副本
            T maskedData = cloneObject(data);
            
            // 获取脱敏规则
            List<MaskingRule> rules = getMaskingRules(clazz.getSimpleName(), policy);
            
            // 应用脱敏规则
            for (MaskingRule rule : rules) {
                applyMaskingRule(maskedData, rule);
            }
            
            return maskedData;
            
        } catch (Exception e) {
            log.error("Data masking failed for class: {}", clazz.getSimpleName(), e);
            throw new DataMaskingException("Failed to mask data", e);
        }
    }
    
    /**
     * 对JSON数据进行脱敏
     */
    public JsonNode maskJsonData(JsonNode data, DataMaskingPolicy policy, String dataType) {
        if (policy == DataMaskingPolicy.NO_MASK) {
            return data;
        }
        
        ObjectMapper mapper = new ObjectMapper();
        JsonNode maskedData = data.deepCopy();
        
        List<MaskingRule> rules = getMaskingRules(dataType, policy);
        
        for (MaskingRule rule : rules) {
            applyJsonMaskingRule(maskedData, rule);
        }
        
        return maskedData;
    }
    
    /**
     * 创建脱敏规则
     */
    public MaskingRule createMaskingRule(CreateMaskingRuleRequest request) {
        MaskingRule rule = MaskingRule.builder()
            .name(request.getName())
            .dataType(request.getDataType())
            .fieldPath(request.getFieldPath())
            .maskingType(request.getMaskingType())
            .maskingPattern(request.getMaskingPattern())
            .conditions(request.getConditions())
            .priority(request.getPriority())
            .createdBy(getCurrentUser().getId())
            .createdAt(Instant.now())
            .build();
        
        rule = maskingRuleRepository.save(rule);
        
        // 清除缓存
        clearMaskingRuleCache();
        
        auditService.logMaskingRuleCreated(rule, getCurrentUser());
        
        return rule;
    }
    
    private List<MaskingRule> getMaskingRules(String dataType, DataMaskingPolicy policy) {
        String cacheKey = "masking_rules:" + dataType + ":" + policy.name();
        
        @SuppressWarnings("unchecked")
        List<MaskingRule> cachedRules = (List<MaskingRule>) redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedRules != null) {
            return cachedRules;
        }
        
        List<MaskingRule> rules = maskingRuleRepository.findByDataTypeAndPolicyOrderByPriority(
            dataType, policy);
        
        // 缓存规则（1小时）
        redisTemplate.opsForValue().set(cacheKey, rules, Duration.ofHours(1));
        
        return rules;
    }
    
    private void applyMaskingRule(Object data, MaskingRule rule) {
        try {
            Field field = getFieldByPath(data.getClass(), rule.getFieldPath());
            if (field != null) {
                field.setAccessible(true);
                Object fieldValue = field.get(data);
                
                if (fieldValue != null) {
                    Object maskedValue = maskValue(fieldValue, rule);
                    field.set(data, maskedValue);
                }
            }
        } catch (Exception e) {
            log.warn("Failed to apply masking rule: {}", rule.getName(), e);
        }
    }
    
    private void applyJsonMaskingRule(JsonNode data, MaskingRule rule) {
        JsonNode targetNode = data.at(rule.getFieldPath());
        if (!targetNode.isMissingNode()) {
            String originalValue = targetNode.asText();
            String maskedValue = maskStringValue(originalValue, rule);
            
            // 更新JSON节点值
            ((ObjectNode) data).put(rule.getFieldPath().substring(rule.getFieldPath().lastIndexOf('/') + 1), maskedValue);
        }
    }
    
    private Object maskValue(Object value, MaskingRule rule) {
        if (value instanceof String) {
            return maskStringValue((String) value, rule);
        } else if (value instanceof Number) {
            return maskNumberValue((Number) value, rule);
        } else if (value instanceof Date) {
            return maskDateValue((Date) value, rule);
        }
        
        return value;
    }
    
    private String maskStringValue(String value, MaskingRule rule) {
        switch (rule.getMaskingType()) {
            case FULL_MASK:
                return "*".repeat(value.length());
            case PARTIAL_MASK:
                return applyPartialMask(value, rule.getMaskingPattern());
            case HASH_MASK:
                return hashValue(value);
            case CUSTOM_MASK:
                return applyCustomMask(value, rule.getMaskingPattern());
            default:
                return value;
        }
    }
    
    private String applyPartialMask(String value, String pattern) {
        // 解析脱敏模式，如 "keep:2,mask:*,keep:2" 表示保留前2位，中间用*替换，保留后2位
        if (pattern == null || value.length() <= 4) {
            return "*".repeat(value.length());
        }
        
        // 简单实现：保留前2位和后2位
        if (value.length() <= 4) {
            return "*".repeat(value.length());
        }
        
        return value.substring(0, 2) + "*".repeat(value.length() - 4) + value.substring(value.length() - 2);
    }
    
    private String hashValue(String value) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            byte[] hash = md.digest(value.getBytes(StandardCharsets.UTF_8));
            return Base64.getEncoder().encodeToString(hash).substring(0, 8);
        } catch (NoSuchAlgorithmException e) {
            return "HASHED";
        }
    }
}
```

### 权限委派和临时授权

#### 权限委派服务
```java
// PermissionDelegationService.java
@Service
public class PermissionDelegationService {
    
    private final DelegationRepository delegationRepository;
    private final TemporaryPermissionRepository temporaryPermissionRepository;
    private final NotificationService notificationService;
    
    /**
     * 创建权限委派
     */
    public Delegation createDelegation(CreateDelegationRequest request) {
        User delegator = getCurrentUser();
        User delegate = userRepository.findById(request.getDelegateUserId())
            .orElseThrow(() -> new UserNotFoundException("Delegate user not found"));
        
        // 验证委派者是否有被委派的权限
        for (Long permissionId : request.getPermissionIds()) {
            if (!hasPermission(delegator, permissionId)) {
                throw new InsufficientPermissionException(
                    "Cannot delegate permission you don't have: " + permissionId);
            }
        }
        
        Delegation delegation = Delegation.builder()
            .delegatorId(delegator.getId())
            .delegateId(delegate.getId())
            .permissionIds(request.getPermissionIds())
            .startTime(request.getStartTime())
            .endTime(request.getEndTime())
            .conditions(request.getConditions())
            .reason(request.getReason())
            .status(DelegationStatus.ACTIVE)
            .createdAt(Instant.now())
            .build();
        
        delegation = delegationRepository.save(delegation);
        
        // 清除被委派人的权限缓存
        cacheService.evictUserPermissionCache(delegate.getId());
        
        // 发送通知
        notificationService.sendDelegationNotification(delegator, delegate, delegation);
        
        // 记录审计日志
        auditService.logPermissionDelegated(delegation, delegator);
        
        return delegation;
    }
    
    /**
     * 撤销权限委派
     */
    public void revokeDelegation(Long delegationId, String reason) {
        Delegation delegation = delegationRepository.findById(delegationId)
            .orElseThrow(() -> new DelegationNotFoundException("Delegation not found"));
        
        User currentUser = getCurrentUser();
        
        // 只有委派者或管理员可以撤销委派
        if (!delegation.getDelegatorId().equals(currentUser.getId()) && 
            !hasRole(currentUser, "ADMIN")) {
            throw new AccessDeniedException("No permission to revoke this delegation");
        }
        
        delegation.setStatus(DelegationStatus.REVOKED);
        delegation.setRevokedAt(Instant.now());
        delegation.setRevokedBy(currentUser.getId());
        delegation.setRevokeReason(reason);
        
        delegationRepository.save(delegation);
        
        // 清除被委派人的权限缓存
        cacheService.evictUserPermissionCache(delegation.getDelegateId());
        
        // 发送通知
        User delegate = userRepository.findById(delegation.getDelegateId()).orElse(null);
        if (delegate != null) {
            notificationService.sendDelegationRevokedNotification(currentUser, delegate, delegation, reason);
        }
        
        auditService.logDelegationRevoked(delegation, currentUser, reason);
    }
    
    /**
     * 创建临时权限
     */
    public TemporaryPermission createTemporaryPermission(CreateTemporaryPermissionRequest request) {
        User grantee = userRepository.findById(request.getGranteeId())
            .orElseThrow(() -> new UserNotFoundException("Grantee not found"));
        
        Permission permission = permissionRepository.findById(request.getPermissionId())
            .orElseThrow(() -> new PermissionNotFoundException("Permission not found"));
        
        // 检查授权者是否有权限授予临时权限
        User grantor = getCurrentUser();
        if (!canGrantTemporaryPermission(grantor, permission)) {
            throw new InsufficientPermissionException("Cannot grant temporary permission");
        }
        
        TemporaryPermission tempPermission = TemporaryPermission.builder()
            .granteeId(grantee.getId())
            .permissionId(permission.getId())
            .grantorId(grantor.getId())
            .startTime(request.getStartTime())
            .endTime(request.getEndTime())
            .maxUsageCount(request.getMaxUsageCount())
            .usageCount(0)
            .reason(request.getReason())
            .conditions(request.getConditions())
            .status(TemporaryPermissionStatus.ACTIVE)
            .createdAt(Instant.now())
            .build();
        
        tempPermission = temporaryPermissionRepository.save(tempPermission);
        
        // 清除用户权限缓存
        cacheService.evictUserPermissionCache(grantee.getId());
        
        // 发送通知
        notificationService.sendTemporaryPermissionGrantedNotification(grantor, grantee, tempPermission);
        
        // 记录审计日志
        auditService.logTemporaryPermissionGranted(tempPermission, grantor);
        
        return tempPermission;
    }
    
    /**
     * 获取用户的委派权限
     */
    public List<Permission> getDelegatedPermissions(Long userId) {
        List<Delegation> activeDelegations = delegationRepository.findActiveByDelegateId(userId);
        
        Set<Long> permissionIds = activeDelegations.stream()
            .flatMap(d -> d.getPermissionIds().stream())
            .collect(Collectors.toSet());
        
        return permissionRepository.findAllById(permissionIds);
    }
    
    /**
     * 获取用户的临时权限
     */
    public List<Permission> getTemporaryPermissions(Long userId) {
        List<TemporaryPermission> activeTemporaryPermissions = 
            temporaryPermissionRepository.findActiveByGranteeId(userId);
        
        Set<Long> permissionIds = activeTemporaryPermissions.stream()
            .map(TemporaryPermission::getPermissionId)
            .collect(Collectors.toSet());
        
        return permissionRepository.findAllById(permissionIds);
    }
    
    /**
     * 使用临时权限（递减使用次数）
     */
    public void useTemporaryPermission(Long tempPermissionId) {
        TemporaryPermission tempPermission = temporaryPermissionRepository.findById(tempPermissionId)
            .orElseThrow(() -> new TemporaryPermissionNotFoundException("Temporary permission not found"));
        
        if (tempPermission.getStatus() != TemporaryPermissionStatus.ACTIVE) {
            throw new InactivePermissionException("Temporary permission is not active");
        }
        
        // 检查使用次数限制
        if (tempPermission.getMaxUsageCount() != null && 
            tempPermission.getUsageCount() >= tempPermission.getMaxUsageCount()) {
            throw new PermissionUsageExceededException("Temporary permission usage limit exceeded");
        }
        
        // 递增使用次数
        tempPermission.setUsageCount(tempPermission.getUsageCount() + 1);
        tempPermission.setLastUsedAt(Instant.now());
        
        // 如果达到使用次数限制，设置为已用完
        if (tempPermission.getMaxUsageCount() != null && 
            tempPermission.getUsageCount() >= tempPermission.getMaxUsageCount()) {
            tempPermission.setStatus(TemporaryPermissionStatus.EXHAUSTED);
        }
        
        temporaryPermissionRepository.save(tempPermission);
        
        auditService.logTemporaryPermissionUsed(tempPermission);
    }
    
    private boolean canGrantTemporaryPermission(User grantor, Permission permission) {
        // 检查授权者是否有该权限
        if (!hasPermission(grantor, permission.getId())) {
            return false;
        }
        
        // 检查是否有授予临时权限的权限
        return hasPermission(grantor, "permission:grant_temporary");
    }
}
```

### 权限审批工作流

#### 权限申请服务
```java
// PermissionRequestService.java
@Service
public class PermissionRequestService {
    
    private final PermissionRequestRepository requestRepository;
    private final WorkflowService workflowService;
    private final NotificationService notificationService;
    
    /**
     * 提交权限申请
     */
    public PermissionRequest submitPermissionRequest(SubmitPermissionRequestRequest request) {
        User requester = getCurrentUser();
        
        // 验证申请的权限是否存在
        List<Permission> permissions = permissionRepository.findAllById(request.getPermissionIds());
        if (permissions.size() != request.getPermissionIds().size()) {
            throw new InvalidPermissionRequestException("Some permissions not found");
        }
        
        PermissionRequest permissionRequest = PermissionRequest.builder()
            .requesterId(requester.getId())
            .permissionIds(request.getPermissionIds())
            .requestType(request.getRequestType())
            .reason(request.getReason())
            .businessJustification(request.getBusinessJustification())
            .requestedDuration(request.getRequestedDuration())
            .urgencyLevel(request.getUrgencyLevel())
            .status(PermissionRequestStatus.PENDING)
            .submittedAt(Instant.now())
            .build();
        
        permissionRequest = requestRepository.save(permissionRequest);
        
        // 启动审批工作流
        String workflowInstanceId = workflowService.startPermissionApprovalWorkflow(
            permissionRequest.getId(), requester.getId());
        
        permissionRequest.setWorkflowInstanceId(workflowInstanceId);
        requestRepository.save(permissionRequest);
        
        // 发送通知给审批者
        List<User> approvers = getApprovers(permissions, requester);
        notificationService.sendPermissionRequestNotification(permissionRequest, approvers);
        
        auditService.logPermissionRequestSubmitted(permissionRequest, requester);
        
        return permissionRequest;
    }
    
    /**
     * 审批权限申请
     */
    public void approvePermissionRequest(Long requestId, ApprovalDecision decision) {
        PermissionRequest request = requestRepository.findById(requestId)
            .orElseThrow(() -> new PermissionRequestNotFoundException("Request not found"));
        
        User approver = getCurrentUser();
        
        // 验证审批者权限
        if (!canApproveRequest(approver, request)) {
            throw new AccessDeniedException("No permission to approve this request");
        }
        
        // 创建审批记录
        PermissionApproval approval = PermissionApproval.builder()
            .requestId(requestId)
            .approverId(approver.getId())
            .decision(decision.getDecision())
            .comments(decision.getComments())
            .approvedAt(Instant.now())
            .build();
        
        approvalRepository.save(approval);
        
        // 推进工作流
        workflowService.completeTask(request.getWorkflowInstanceId(), approver.getId(), decision);
        
        // 如果是最终批准，授予权限
        if (decision.getDecision() == ApprovalDecision.Decision.APPROVED && 
            isRequestFullyApproved(requestId)) {
            grantRequestedPermissions(request);
            request.setStatus(PermissionRequestStatus.APPROVED);
            request.setApprovedAt(Instant.now());
        } else if (decision.getDecision() == ApprovalDecision.Decision.REJECTED) {
            request.setStatus(PermissionRequestStatus.REJECTED);
            request.setRejectedAt(Instant.now());
        }
        
        requestRepository.save(request);
        
        // 发送通知
        User requester = userRepository.findById(request.getRequesterId()).orElse(null);
        if (requester != null) {
            notificationService.sendApprovalDecisionNotification(request, approval, requester);
        }
        
        auditService.logPermissionRequestApproved(request, approval, approver);
    }
    
    /**
     * 获取待审批的权限申请
     */
    public Page<PermissionRequest> getPendingRequests(Long approverId, Pageable pageable) {
        return requestRepository.findPendingRequestsForApprover(approverId, pageable);
    }
    
    /**
     * 获取用户的权限申请历史
     */
    public Page<PermissionRequest> getUserRequestHistory(Long userId, Pageable pageable) {
        return requestRepository.findByRequesterIdOrderBySubmittedAtDesc(userId, pageable);
    }
    
    private List<User> getApprovers(List<Permission> permissions, User requester) {
        Set<User> approvers = new HashSet<>();
        
        for (Permission permission : permissions) {
            // 根据权限类型和组织架构确定审批者
            List<User> permissionApprovers = getPermissionApprovers(permission, requester);
            approvers.addAll(permissionApprovers);
        }
        
        return new ArrayList<>(approvers);
    }
    
    private List<User> getPermissionApprovers(Permission permission, User requester) {
        List<User> approvers = new ArrayList<>();
        
        // 根据权限敏感度确定审批层级
        switch (permission.getSensitivityLevel()) {
            case HIGH:
                // 高敏感度权限需要部门经理和安全管理员审批
                approvers.addAll(getDepartmentManagers(requester.getDepartmentId()));
                approvers.addAll(getSecurityAdministrators());
                break;
            case MEDIUM:
                // 中等敏感度权限需要直接上级审批
                approvers.addAll(getDirectSupervisors(requester.getId()));
                break;
            case LOW:
            default:
                // 低敏感度权限需要团队负责人审批
                approvers.addAll(getTeamLeaders(requester.getTeamId()));
                break;
        }
        
        return approvers;
    }
    
    private void grantRequestedPermissions(PermissionRequest request) {
        User requester = userRepository.findById(request.getRequesterId()).orElse(null);
        if (requester == null) {
            return;
        }
        
        for (Long permissionId : request.getPermissionIds()) {
            // 根据申请类型授予权限
            switch (request.getRequestType()) {
                case PERMANENT:
                    assignPermissionToUser(requester.getId(), permissionId, null);
                    break;
                case TEMPORARY:
                    createTemporaryPermission(CreateTemporaryPermissionRequest.builder()
                        .granteeId(requester.getId())
                        .permissionId(permissionId)
                        .endTime(Instant.now().plus(request.getRequestedDuration()))
                        .reason("Approved permission request: " + request.getId())
                        .build());
                    break;
            }
        }
    }
}
```

### Testing

#### 测试标准
- **权限管理测试**: 验证权限创建、分配、撤销的正确性
- **访问控制测试**: 测试资源级权限控制的准确性
- **工作流测试**: 验证权限申请和审批流程
- **性能测试**: 测试权限评估和缓存的性能

#### 测试框架
- **JUnit 5**: 单元测试框架
- **Spring Boot Test**: 集成测试支持
- **TestContainers**: 数据库和消息队列测试容器
- **Mockito**: 模拟对象框架

#### 测试覆盖率要求
- 权限管理服务测试覆盖率 > 95%
- 访问控制测试覆盖率 > 90%
- 工作流服务测试覆盖率 > 85%
- 集成测试覆盖关键权限流程 > 80%

#### 性能测试指标
- 权限检查响应时间 < 50ms
- 权限评估响应时间 < 100ms
- 批量权限检查处理能力 > 5000 TPS
- 权限缓存命中率 > 90%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-XX | 1.0 | 初始故事创建 | Scrum Master |

## Dev Agent Record

### Agent Model Used
*待开发代理填写*

### Debug Log References
*待开发代理填写*

### Completion Notes List
*待开发代理填写*

### File List
*待开发代理填写*

## QA Results
*待QA代理填写*