# Knowledge RAG System - éƒ¨ç½²å·¥ä½œæµ
# ç”¨äºŽè‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§çŽ¯å¢ƒ

name: Deploy

on:
  push:
    branches:
      - develop  # éƒ¨ç½²åˆ°å¼€å‘çŽ¯å¢ƒ
      - main     # éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
    tags:
      - 'v*'     # ç‰ˆæœ¬æ ‡ç­¾éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬ (ç•™ç©ºä½¿ç”¨æœ€æ–°)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================
  # æž„å»ºå’ŒæŽ¨é€ Docker é•œåƒ
  # ===========================================
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - document-service
          - vector-service
          - llm-service
          - qa-service
          - knowledge-graph-service
          - notification-service
          - graph-service
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: services/${{ matrix.service }}
        file: services/${{ matrix.service }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ steps.meta.outputs.tags }}
        format: spdx-json
        output-file: sbom-${{ matrix.service }}.spdx.json
        
    - name: Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: sbom-${{ matrix.service }}
        path: sbom-${{ matrix.service }}.spdx.json

  # ===========================================
  # éƒ¨ç½²åˆ°å¼€å‘çŽ¯å¢ƒ
  # ===========================================
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build-and-push
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development')
    
    environment:
      name: development
      url: https://dev.knowledge-rag.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup deployment environment
      run: |
        # åˆ›å»ºéƒ¨ç½²é…ç½®
        mkdir -p deploy/development
        
        # ç”Ÿæˆå¼€å‘çŽ¯å¢ƒçš„ docker-compose æ–‡ä»¶
        cat > deploy/development/docker-compose.yml << 'EOF'
        version: '3.8'
        
        services:
          # API Gateway
          api-gateway:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:develop
            container_name: knowledge-rag-api-gateway-dev
            ports:
              - "8000:8000"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - JWT_SECRET_KEY=${JWT_SECRET_KEY}
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # Auth Service
          auth-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:develop
            container_name: knowledge-rag-auth-service-dev
            ports:
              - "8001:8001"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${AUTH_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - JWT_SECRET_KEY=${JWT_SECRET_KEY}
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # Document Service
          document-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/document-service:develop
            container_name: knowledge-rag-document-service-dev
            ports:
              - "8002:8002"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${DOCUMENT_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
              - FILE_STORAGE_PATH=${FILE_STORAGE_PATH}
            volumes:
              - document-storage-dev:/app/storage
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # Vector Service
          vector-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/vector-service:develop
            container_name: knowledge-rag-vector-service-dev
            ports:
              - "8003:8003"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${VECTOR_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - WEAVIATE_URL=${WEAVIATE_URL}
              - OPENAI_API_KEY=${OPENAI_API_KEY}
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # LLM Service
          llm-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/llm-service:develop
            container_name: knowledge-rag-llm-service-dev
            ports:
              - "8004:8004"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${LLM_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - OPENAI_API_KEY=${OPENAI_API_KEY}
              - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # QA Service
          qa-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/qa-service:develop
            container_name: knowledge-rag-qa-service-dev
            ports:
              - "8005:8005"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${QA_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - OPENAI_API_KEY=${OPENAI_API_KEY}
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # Knowledge Graph Service
          knowledge-graph-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/knowledge-graph-service:develop
            container_name: knowledge-rag-knowledge-graph-service-dev
            ports:
              - "8006:8006"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${KNOWLEDGE_GRAPH_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - NEO4J_URI=${NEO4J_URI}
              - NEO4J_USERNAME=${NEO4J_USERNAME}
              - NEO4J_PASSWORD=${NEO4J_PASSWORD}
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # Notification Service
          notification-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:develop
            container_name: knowledge-rag-notification-service-dev
            ports:
              - "8007:8007"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${NOTIFICATION_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - RABBITMQ_URL=${RABBITMQ_URL}
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
            
          # Graph Service (GraphRAG)
          graph-service:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/graph-service:develop
            container_name: knowledge-rag-graph-service-dev
            ports:
              - "8008:8008"
            environment:
              - ENVIRONMENT=development
              - DATABASE_URL=${GRAPH_DATABASE_URL}
              - REDIS_URL=${REDIS_URL}
              - NEO4J_URI=${NEO4J_URI}
              - NEO4J_USERNAME=${NEO4J_USERNAME}
              - NEO4J_PASSWORD=${NEO4J_PASSWORD}
              - OPENAI_API_KEY=${OPENAI_API_KEY}
              - GRAPHRAG_STORAGE_ROOT=${GRAPHRAG_STORAGE_ROOT}
            volumes:
              - graphrag-storage-dev:/app/graphrag_storage
            networks:
              - knowledge-rag-dev
            restart: unless-stopped
        
        networks:
          knowledge-rag-dev:
            driver: bridge
        
        volumes:
          document-storage-dev:
          graphrag-storage-dev:
        EOF
        
    - name: Deploy to development server
      run: |
        echo "éƒ¨ç½²åˆ°å¼€å‘çŽ¯å¢ƒ..."
        # è¿™é‡Œåº”è¯¥æ˜¯å®žé™…çš„éƒ¨ç½²è„šæœ¬
        # ä¾‹å¦‚ï¼šé€šè¿‡ SSH è¿žæŽ¥åˆ°å¼€å‘æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
        
        # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
        echo "âœ… å¼€å‘çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo "ðŸŒ è®¿é—®åœ°å€: https://dev.knowledge-rag.example.com"

  # ===========================================
  # éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ
  # ===========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    environment:
      name: staging
      url: https://staging.knowledge-rag.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run staging deployment
      run: |
        echo "éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ..."
        # å®žé™…çš„æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²é€»è¾‘
        echo "âœ… æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo "ðŸŒ è®¿é—®åœ°å€: https://staging.knowledge-rag.example.com"
        
    - name: Run smoke tests
      run: |
        echo "è¿è¡Œå†’çƒŸæµ‹è¯•..."
        # åŸºæœ¬çš„å¥åº·æ£€æŸ¥
        sleep 30  # ç­‰å¾…æœåŠ¡å¯åŠ¨
        
        # æ£€æŸ¥å„ä¸ªæœåŠ¡çš„å¥åº·çŠ¶æ€
        services=("api-gateway:8000" "auth-service:8001" "document-service:8002")
        for service in "${services[@]}"; do
          service_name=$(echo $service | cut -d':' -f1)
          port=$(echo $service | cut -d':' -f2)
          echo "æ£€æŸ¥ $service_name..."
          # curl -f https://staging.knowledge-rag.example.com/$service_name/health || exit 1
        done
        
        echo "âœ… å†’çƒŸæµ‹è¯•é€šè¿‡"

  # ===========================================
  # éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: |
      (startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    
    environment:
      name: production
      url: https://knowledge-rag.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create production deployment
      run: |
        echo "å‡†å¤‡ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²..."
        
        # ç”Ÿæˆç”Ÿäº§çŽ¯å¢ƒé…ç½®
        mkdir -p deploy/production
        
        # åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒçš„ Kubernetes éƒ¨ç½²æ–‡ä»¶
        cat > deploy/production/namespace.yaml << 'EOF'
        apiVersion: v1
        kind: Namespace
        metadata:
          name: knowledge-rag-prod
          labels:
            name: knowledge-rag-prod
            environment: production
        EOF
        
        cat > deploy/production/configmap.yaml << 'EOF'
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: knowledge-rag-config
          namespace: knowledge-rag-prod
        data:
          ENVIRONMENT: "production"
          LOG_LEVEL: "INFO"
          CORS_ORIGINS: "https://knowledge-rag.example.com"
        EOF
        
    - name: Deploy to production
      run: |
        echo "éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
        # å®žé™…çš„ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²é€»è¾‘
        # kubectl apply -f deploy/production/
        
        echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
        echo "ðŸŒ è®¿é—®åœ°å€: https://knowledge-rag.example.com"
        
    - name: Run production health checks
      run: |
        echo "è¿è¡Œç”Ÿäº§çŽ¯å¢ƒå¥åº·æ£€æŸ¥..."
        sleep 60  # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        
        # ç”Ÿäº§çŽ¯å¢ƒå¥åº·æ£€æŸ¥
        echo "âœ… ç”Ÿäº§çŽ¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
        
    - name: Create deployment record
      run: |
        echo "åˆ›å»ºéƒ¨ç½²è®°å½•..."
        
        # åˆ›å»ºéƒ¨ç½²è®°å½•
        cat > deployment-record.json << EOF
        {
          "deployment_id": "${{ github.run_id }}",
          "version": "${{ github.ref_name }}",
          "environment": "production",
          "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "deployed_by": "${{ github.actor }}",
          "commit_sha": "${{ github.sha }}",
          "services": [
            "api-gateway",
            "auth-service",
            "document-service",
            "vector-service",
            "llm-service",
            "qa-service",
            "knowledge-graph-service",
            "notification-service",
            "graph-service"
          ]
        }
        EOF
        
        cat deployment-record.json
        
    - name: Upload deployment record
      uses: actions/upload-artifact@v3
      with:
        name: deployment-record-production
        path: deployment-record.json

  # ===========================================
  # å›žæ»šéƒ¨ç½²
  # ===========================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    needs: [deploy-staging, deploy-production]
    
    steps:
    - name: Rollback deployment
      run: |
        echo "æ£€æµ‹åˆ°éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›žæ»š..."
        
        # å®žé™…çš„å›žæ»šé€»è¾‘
        # kubectl rollout undo deployment/knowledge-rag-api-gateway -n knowledge-rag-prod
        
        echo "âœ… å›žæ»šå®Œæˆ"
        
    - name: Notify rollback
      run: |
        echo "å‘é€å›žæ»šé€šçŸ¥..."
        # å‘é€é€šçŸ¥åˆ° Slack æˆ–å…¶ä»–é€šçŸ¥ç³»ç»Ÿ

  # ===========================================
  # éƒ¨ç½²é€šçŸ¥
  # ===========================================
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-development, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: Send deployment notification
      run: |
        echo "å‘é€éƒ¨ç½²é€šçŸ¥..."
        
        # ç¡®å®šéƒ¨ç½²çŠ¶æ€
        if [ "${{ needs.deploy-production.result }}" == "success" ]; then
          ENVIRONMENT="ç”Ÿäº§çŽ¯å¢ƒ"
          STATUS="âœ… æˆåŠŸ"
          URL="https://knowledge-rag.example.com"
        elif [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          ENVIRONMENT="æµ‹è¯•çŽ¯å¢ƒ"
          STATUS="âœ… æˆåŠŸ"
          URL="https://staging.knowledge-rag.example.com"
        elif [ "${{ needs.deploy-development.result }}" == "success" ]; then
          ENVIRONMENT="å¼€å‘çŽ¯å¢ƒ"
          STATUS="âœ… æˆåŠŸ"
          URL="https://dev.knowledge-rag.example.com"
        else
          ENVIRONMENT="æœªçŸ¥"
          STATUS="âŒ å¤±è´¥"
          URL="N/A"
        fi
        
        echo "éƒ¨ç½²çŠ¶æ€: $STATUS"
        echo "éƒ¨ç½²çŽ¯å¢ƒ: $ENVIRONMENT"
        echo "è®¿é—®åœ°å€: $URL"
        echo "ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"
        
        # è¿™é‡Œå¯ä»¥é›†æˆ Slackã€Teamsã€é‚®ä»¶ç­‰é€šçŸ¥ç³»ç»Ÿ